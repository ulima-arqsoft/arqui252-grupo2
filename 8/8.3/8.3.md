> [8. Aplicaci√≥n de Patrones Arquitecturales](../8.md) ‚Ä∫ [8.3. M√≥dulo 3 / Integrante 3](8.3.md)

# 8.3. M√≥dulo 3 ‚Äì Autenticaci√≥n y Seguridad

El M√≥dulo de Autenticaci√≥n y Seguridad es responsable de garantizar la identidad de los usuarios, controlar el acceso a recursos protegidos, gestionar credenciales sensibles y preservar la integridad de las sesiones en toda la plataforma  
Este m√≥dulo centraliza los procesos de login, registro, verificaci√≥n de correo, autenticaci√≥n multifactor, recuperaci√≥n de cuenta, administraci√≥n de roles y validaci√≥n de tokens, integr√°ndose con el resto de la arquitectura a trav√©s de servicios REST y eventos asincr√≥nicos

Dado que cualquier vulnerabilidad en este m√≥dulo compromete la plataforma completa, su arquitectura incorpora patrones de seguridad, escalabilidad y resiliencia orientados a reducir riesgos sin sacrificar rendimiento ni experiencia de usuario‚ö†Ô∏è *experincia*

---

## Patrones de M√≥dulo

## **ADR 1: Arquitectura en Capas (Layered Architecture)**

### **Contexto**
El m√≥dulo incluye operaciones altamente cr√≠ticas: hashing de contrase√±as, validaci√≥n de tokens, verificaci√≥n de identidad, configuraci√≥n de m√©todos 2FA, detecci√≥n de actividades sospechosas y control r√≠gido de roles y propietarios  
Implementar estas responsabilidades directamente en rutas o en acceso a datos producir√≠a c√≥digo dif√≠cil de mantener, propenso a errores y con alta fragilidad ante cambios‚ö†Ô∏è *fragildad*

### **Decisi√≥n**
Se adopta una arquitectura en capas con separaci√≥n estricta

- **Capa de Presentaci√≥n (Routes/Controllers):** valida entrada, define contratos y orquesta procesos
- **Capa de Servicios:** agrupa l√≥gica de autenticaci√≥n, seguridad, sesiones, 2FA, verificaci√≥n y administraci√≥n
- **Capa de Repositorios:** acceso abstracto a PostgreSQL y Redis (usuarios, tokens, bloqueo, notificaciones)
- **Capa de Infraestructura:** integra herramientas externas (SendGrid, JWT, Redis, brokers de mensajes, m√©tricas)

### **Consecuencias**
- Aumenta mantenibilidad y facilidad de pruebas
- Permite agregar nuevas pol√≠ticas (ej nuevos m√©todos 2FA) sin modificar rutas
- Reduce el riesgo de introducir vulnerabilidades por duplicaci√≥n de l√≥gica
- Facilita auditor√≠a y trazabilidad de decisiones de seguridad

---

## Patrones de Componentes y Conectores

## **ADR 2: Cliente‚ÄìServidor mediante API REST**

### **Contexto**
Los clientes del sistema (frontends administrativos, frontends estudiantiles y microservicios internos) requieren una interfaz bien definida para autenticarse, solicitar tokens, realizar verificaciones y ejecutar flujos cr√≠ticos de seguridad en tiempo real

### **Decisi√≥n**
El m√≥dulo expone una **API REST** que cubre todas las funciones del servicio

- `/auth/login`, `/auth/login/2fa`
- `/auth/refresh`
- `/auth/register`, `/auth/verify-email`
- `/auth/forgot-password`, `/auth/reset-password`
- `/auth/logout`, `/auth/logout-all`
- `/auth/2fa/...`
- `/users/...` (solo administradores)

### **Consecuencias**
- Interoperabilidad con cualquier cliente web o m√≥vil
- Aislamiento total del m√≥dulo respecto de sus consumidores
- Baja latencia en operaciones cr√≠ticas
- Contratos estables que facilitan futuras extensiones

---

## **ADR 3: Publish‚ÄìSubscribe con RabbitMQ**

### **Contexto**
Cambios en autenticaci√≥n como creaci√≥n de usuarios, verificaci√≥n de correos, cambios de rol o alertas de seguridad deben ser notificados de inmediato a otros microservicios  
Consultas directas generar√≠an acoplamiento y podr√≠an desestabilizar la plataforma bajo carga

### **Decisi√≥n**
El m√≥dulo publica eventos mediante **RabbitMQ**, tales como

- `user.created`
- `user.updated`
- `user.deleted`
- `role.updated`
- `security.event`
- `account.state.updated`

### **Consecuencias**
- Los dem√°s servicios se mantienen sincronizados sin depender de la base de datos del m√≥dulo
- Se evita acoplamiento directo entre dominios
- Permite auditar, cachear o replicar informaci√≥n en otros servicios sin afectar al AuthService
- Mejora la escalabilidad general del sistema

---

## **ADR 4: Arquitectura Orientada a Servicios (SOA)**

### **Contexto**
La responsabilidad del m√≥dulo no puede mezclarse con otros dominios como calificaciones o perfiles  
El sistema requiere exponer funcionalidades de seguridad mediante interfaces estables e independientes

### **Decisi√≥n**
El AuthService opera como un servicio aut√≥nomo con un conjunto claro de capacidades

- Gesti√≥n de identidad  
- Gesti√≥n de tokens  
- Gesti√≥n de roles y estados  
- Seguridad multifactor  
- Notificaciones de seguridad  
- Revocaci√≥n global de sesiones  
- Sincronizaci√≥n de datos v√≠a eventos  

### **Consecuencias**
- Permite que los dem√°s m√≥dulos consuman funcionalidades sin riesgo de acoplamiento
- Facilita la evoluci√≥n del sistema hacia microservicios m√°s especializados
- Protege las responsabilidades de seguridad frente a cambios no controlados‚ö†Ô∏è *incontrolados*

---

## Patrones Cloud

## **ADR 5: Rate-Limiting Distribuido y Escalado Horizontal**

### **Contexto**
El inicio de sesi√≥n y la verificaci√≥n 2FA pueden experimentar picos de solicitudes  
Sin control, esto afectar√≠a tiempos de respuesta y habilitar√≠a ataques de fuerza bruta o denegaci√≥n de servicio

### **Decisi√≥n**
Se implementa

- **Rate-limit por IP y por usuario** para el login  
- Soporte para **escalado horizontal**, utilizando Redis y JWT para mantener la aplicaci√≥n sin estado  
- **Bloqueo temporal autom√°tico** ante m√∫ltiples intentos fallidos

### **Consecuencias**
- El sistema mantiene tiempos de respuesta predecibles
- El m√≥dulo puede escalar sin restricciones al aumentar la demanda
- Los intentos maliciosos no afectan a usuarios leg√≠timos

---

## **ADR 6: Circuit Breaker + Backoff para Env√≠o de Correos/OTP**

### **Contexto**
El proveedor de correo es cr√≠tico en flujos como registro, verificaci√≥n, login 2FA y recuperaci√≥n de cuenta  
Las fallas del proveedor no deben detener la operaci√≥n del sistema

### **Decisi√≥n**
El m√≥dulo integra

- **Reintentos autom√°ticos**  
- **Backoff exponencial**  
- **Circuit breaker** de 1 minuto  
- Un error especializado `EmailProviderUnavailableError`  
- Mensajes amigables para el usuario  
- Rutas alternas como TOTP y c√≥digos de respaldo

### **Consecuencias**
- Los flujos de autenticaci√≥n se degradan suavemente ante fallos externos
- El sistema sigue operativo incluso ante ca√≠das del proveedor de correo
- Mejora la disponibilidad general del m√≥dulo

---

## **ADR 7: Detecci√≥n de Sesi√≥n Secuestrada y Revocaci√≥n Global**

### **Contexto**
Los refresh tokens pueden ser robados mediante XSS, malware o redes p√∫blicas  
Aceptar un refresh sin validaciones adicionales permitir√≠a que un atacante mantenga sesi√≥n activa indefinidamente

### **Decisi√≥n**
Cada refresh token almacena

- IP  
- User-Agent  
- Expiraci√≥n  
- Estado (revocado o no)

Y la ruta `/auth/refresh`

- Compara IP y User-Agent originales con los actuales  
- Ante discrepancias:
  - revoca todos los tokens activos  
  - registra un evento de seguridad  
  - solicita un nuevo inicio de sesi√≥n  

### **Consecuencias**
- Detiene secuestros de sesi√≥n en tiempo real
- Minimiza el da√±o en caso de filtraci√≥n de tokens
- Fortalece la integridad del sistema

---

## **ADR 8: Control de Acceso Basado en Roles (RBAC) mediante Middlewares**

### **Contexto**
Las rutas de usuario incluyen operaciones cr√≠ticas como modificar estado de cuenta o aprobar nuevos administradores  
Deben protegerse mediante autorizaci√≥n adem√°s de autenticaci√≥n

### **Decisi√≥n**
Se implementan middlewares

- `requireRole("admin")`  
- `requireOwnerOrRole("admin")`

### **Consecuencias**
- Garantiza que solo administradores realicen acciones sensibles
- Evita uso inapropiado de rutas por usuarios autenticados
- Autoriza de forma centralizada y uniforme

---

## Resumen de Patrones Aplicados

| Categor√≠a | Patr√≥n | Rol en el m√≥dulo |
|----------|--------|------------------|
| **M√≥dulo** | Arquitectura en capas | Estructura uniforme y mantenible |
| **Conectores** | API REST | Interfaz clara entre clientes y microservicios |
| **Conectores** | Publish‚ÄìSubscribe | Sincronizaci√≥n sin acoplamiento |
| **SOA** | Servicio aut√≥nomo | Aislamiento del dominio de seguridad |
| **Cloud** | Rate-limit + escalado horizontal | Manejo de carga y resiliencia |
| **Cloud** | Circuit breaker + backoff | Tolerancia a fallos |
| **Seguridad** | RBAC | Autorizaci√≥n estricta |
| **Seguridad** | Refresh seguro | Integridad de sesi√≥n |
| **Seguridad** | Notificaciones de seguridad | Auditor√≠a y alertas |
| **Seguridad** | 2FA | Protecci√≥n multifactor |

---

# Conclusi√≥n

El M√≥dulo de Autenticaci√≥n y Seguridad aplica un conjunto de patrones arquitect√≥nicos que equilibran robustez, escalabilidad, resiliencia y experiencia de usuario  
Gracias a la separaci√≥n por capas, uso de eventos, control de acceso centralizado, mecanismos avanzados de detecci√≥n de anomal√≠as y tolerancia a fallos externos, el m√≥dulo garantiza la seguridad integral de la plataforma sin comprometer su desempe√±o




[‚¨ÖÔ∏è Anterior](../8.2/8.2.md) | [üè† Home](../../README.md) | [Siguiente ‚û°Ô∏è](../8.4/8.4.md)