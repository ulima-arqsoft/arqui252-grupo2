> [0. Acerca del Grupo](../../0.md) ‚Ä∫ [0.7. Trabajo Individual (Patrones Cloud)](../0.7.md) ‚Ä∫ [0.7.3. Integrante 3](0.7.3.md)

# 0.7.3. Integrante 3


#  Health Endpoint Monitoring ‚Äî Dise√±o e Implementaci√≥n (Edu Rank)

**Repositorio de la demo:** [https://github.com/ulima-arqsoft/arqui252-enriquez-leon/tree/main/edurank-health-demo](https://github.com/ulima-arqsoft/arqui252-enriquez-leon/tree/main/edurank-health-demo) 

---

## 1. Resumen

El patr√≥n **Health Endpoint Monitoring** permite exponer el estado de salud de un servicio mediante endpoints HTTP para que orquestadores o balanceadores y herramientas como **Prometheus** y **Grafana** determinen si enviar trafico, alertar o accionar (reinicios, retirar de balanceo, etc)

En **Edu Rank** ‚Äîarquitectura de microservicios (Auth, Rese√±as, Administracion)‚Äî se implementan los endpoints

- `/health/live`
- `/health/ready`
- `/health/startup`
- `/metrics` (Prometheus)

El monitoreo se complementa con **Blackbox Exporter**, que valida la salud ‚Äúdesde afuera‚Äù, simulando la visi√≥n de un cliente externo

---

## 2. Desarrollo del Patr√≥n

### 2.1 Problema

En sistemas distribuidos es com√∫n que

- Un proceso est√© vivo pero no apto para recibir trafico (dependencias caidas, migraciones, calentamiento de cach√©s)  
- Las caidas sean parciales y no se detecten a tiempo (degradaci√≥n silenciosa)  
- El balanceador envie trafico a instancias no listas generando errores o picos de latencia

**Necesidad:** un mecanismo fiable, estandar y automatizable para descubrir el estado real de cada microservicio y actuar en consecuencia

---

### 2.2 Soluci√≥n (Patr√≥n)

Exponer endpoints de salud con responsabilidades claras

| Endpoint | Prop√≥sito | Caracteristicas |
|-----------|------------|----------------|
| `/health/live` | Verifica que el proceso responda (sin I/O externo) | Reinicios automaticos si el proceso se cuelga |
| `/health/ready` | Verifica dependencias criticas (DB, cache, colas, claves) | 503 si falla alguna dependencia critica |
| `/health/startup` | Indica si el bootstrap termin√≥ correctamente | Evita falsos positivos en arranque |
| `/metrics` | Expone m√©tricas en formato Prometheus | Latencia, conteos, CPU/memoria, readiness |

**Integraciones**

- **Prometheus:** scrapea `/metrics` y sonda `/health/*`  
- **Grafana:** dashboards con estado, dependencias y latencias  
- **Alertmanager:** notifica ante fallas sostenidas (>2 minutos)

**Buenas practicas**

- `/live` rapido, sin dependencias externas  
- `/ready` con timeout corto y cache (TTL 2‚Äì5 s)  
- `/ready` y `/startup` no p√∫blicos  
- `/metrics` con baja cardinalidad en etiquetas

---

### 2.3 Casos de Aplicaci√≥n (Industria)

- **Fintech / Pagos:** retirar nodos si fallan dependencias criticas (core-banking)  
- **E-commerce:** degradar el servicio si el buscador falla sin detener ventas  
- **SaaS multi-tenant:** aislar fallas de tenants especificos  
- **Medios/Streaming:** sondas externas para validar disponibilidad p√∫blica

---

## 3. Aplicaci√≥n en el Proyecto Grupal (Edu Rank)

### 3.1 Arquitectura de Referencia

**Microservicios:** Auth, Administracion, rese√±as, Ranking (futuro)  
**Dependencias criticas:** PostgreSQL (persistencia), Redis (cache)  
**Observabilidad:** Prometheus + Blackbox Exporter + Grafana  
**Gateway (futuro):** expone solo `/health/public` (basado en liveness)

---

### 3.2 Integraci√≥n del Patr√≥n

Cada servicio expone

- `GET /health/live` ‚Üí reinicio si no responde  
- `GET /health/ready` ‚Üí trafico solo si DB/Redis disponibles (503 si no)  
- `GET /health/startup` ‚Üí controla el estado durante el arranque  
- `GET /metrics` ‚Üí m√©tricas: latencias, errores, readiness, dependencias

**Prometheus**
- Scrapea `/metrics` por servicio  
- Blackbox sondea `/health/ready` y `/health/live`

**Grafana**
- Paneles de:
  - Estado de Readiness por servicio (gauge)  
  - Dependencias (tabla service_dependency_up)  
  - Latencia p95 por ruta/servicio  
  - Error rate (% fallos)

**Alertas**
- `ServiceDown`: no scrapea  
- `ReadinessFailed`: readiness en 0 sostenido  
- `DependencyDown`: dependencia critica caida  

---

### 3.3 Valor que Aporta

- **Disponibilidad:** evita trafico a instancias no listas  
- **Resiliencia:** degradaci√≥n controlada sin caida total  
- **Diagn√≥stico:** dashboards y alertas por dependencia  
- **Evoluci√≥n:** base lista para probes nativos de Kubernetes

---

## 4. Desarrollo de la Demo

### Dise√±o de Endpoints

- `/health/live`, `/health/ready`, `/health/startup`, `/metrics`  
- Politica: `/ready` y `/startup` internos, `/live` p√∫blico

### M√©tricas y Etiquetas

- Latencia por ruta/servicio (histogram)  
- Readiness (gauge 0/1)  
- Dependencias por servicio (gauge 0/1)  
- Tasas de error (calculadas en Prometheus)

### Monitoreo

- Prometheus: scrape_configs por microservicio  
- Blackbox Exporter: sondas HTTP externas  
- Alertas por caidas o readiness=0 sostenido

### Visualizaci√≥n

- Grafana: dashboards de readiness, dependencias, latencias p95 y error rate

### Validaci√≥n

- **Fallas:** apagar Redis/Postgres ‚Üí readiness=0 ‚Üí alerta  
- **Arranque lento:** startup 503 ‚Üí luego 200  
- **Degradaci√≥n controlada:** dependencia no critica falla ‚Üí modo degradado  
- En la practica el sistema reaccion√≥ correctamente pero a veces tarda unos segundos en actualizar las m√©tricas

---

## 5. Casos de Uso en Edu Rank

| Servicio | Escenario | Acci√≥n del Patr√≥n |
|-----------|------------|-------------------|
| Autenticacion | Postgres cae | readiness=0 ‚Üí Gateway evita logins |
| Administracion | Redis falla | modo degradado  |
| Rese√±as | API externa falla | servicio sigue con datos internos |

---

## 6. Criterios de Aceptaci√≥n

| C√≥digo | Descripci√≥n |
|--------|--------------|
| CA-01 | Cada servicio expone `/health/live`, `/health/ready`, `/metrics` |
| CA-02 | Readiness retorna 503 si falla dependencia critica (<1s) |
| CA-03 | Prometheus y Grafana visualizan readiness, dependencias, p95 |
| CA-04 | Alertas ante caida o fallas > 2 minutos |
| CA-05 | Documentaci√≥n de runbooks por tipo de alerta |

---

## 7. Trade-offs y Riesgos

- Sobrecarga minima ‚Üí mitigada con TTL/timeout  
- Riesgo de exposici√≥n interna ‚Üí mitigado restringiendo endpoints  
- Cardinalidad de m√©tricas ‚Üí mitigado con etiquetas controladas  
- En algunos entornos la config de scrape puede dar warning si el hostname cambia

---

## Evidencia

![Evidencia de ejecuci√≥n de la demo](grafana-overview.png)


[‚¨ÖÔ∏è Anterior](../0.7.2/0.7.2.md) | [üè† Home](../../../README.md) | [Siguiente ‚û°Ô∏è](../0.7.4/0.7.4.md)